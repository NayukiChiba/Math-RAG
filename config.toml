# Math-RAG 全局配置（TOML）

[paths]
# 目录路径均相对项目根目录
processed_dir = "data/processed"
model_output_json = "data/processed/ma_terms_model.json"

[ocr]
# OCR 页码范围（页码从 0 开始，-1 表示不限制）
page_start = 0
page_end = -1
skip_existing = true
# 图像最大尺寸（宽, 高），用于限制内存占用
max_image_size = [1280, 1280]
# 文本分块最大字符数
max_page_chars = 1800
# 术语最大长度
max_term_len = 16
# 术语提取最大 token 数
term_max_tokens = 300
# 每个术语最多关联的页数
max_pages_per_term = 6

[model]
# OpenAI 兼容接口配置
api_base = "https://api.deepseek.com/v1"
model = "deepseek-chat"
# 你的 .env 使用 API-KEY，这里保持一致
api_key_env = "API-KEY"
subject_label = "数学分析"
seed_terms = [
  "复合函数",
  "外函数",
  "内函数",
  "中间变量",
  "复合运算",
  "定义域",
  "存在域",
  "值域",
  "反函数",
  "自变量",
  "因变量",
  "函数",
  "一一映射",
  "逆映射",
  "原象",
  "确界定理",
  "上确界",
  "幂函数",
  "指数函数",
  "有理指数幂",
  "无理指数幂",
  "实指数幂",
  "确界",
  "唯一性",
  "正数",
  "无理数",
  "有理数",
  "非空数集",
  "确界原理",
  "初等函数",
  "非初等函数",
  "狄利克雷函数",
  "黎曼函数",
  "常量函数",
  "对数函数",
  "三角函数",
  "正弦函数",
  "余弦函数",
  "正切函数",
  "余切函数",
  "反三角函数",
  "反正弦函数",
  "反余弦函数",
  "反正切函数",
  "反余切函数",
  "下确界",
  "分段函数",
  "解析表示式",
  "图像",
  "等式",
  "函数图像",
  "函数等式",
  "有界函数",
  "上界",
  "下界",
  "无上界函数",
  "界函数",
]
max_tokens = 900
temperature = 0.3
top_p = 0.9
max_retries = 2
max_attempts = 5
min_definition_chars = 40
min_usage_chars = 20
min_applications_chars = 20
min_formula_count = 1
# 请求控制
endpoint = "/chat/completions"
request_timeout = 60
# rpm = 800
# tpm = 40000
retry_wait_seconds = 2
clear_context_each_request = true
# 流式输出
stream = true
# 起始索引（1-based）
start_index = 1
# OCR 分页来源配置
ocr_book_title = "数学分析(第5版) 上 (华东师范大学数学系)"
ocr_pages_dir = "data/processed/ocr/数学分析(第5版) 上 (华东师范大学数学系)/pages"
ocr_terms_with_pages_path = "data/processed/terms_from_ocr_map.json"

# 提示词模板（占位符：{{term}} {{subject_label}} {{example}} {{reason}} {{bad_json}}）
prompt_system = '''
你是数学术语编纂助手。请为指定术语生成标准化 JSON。必须严格输出 JSON 对象，不要输出多余解释。
'''

prompt_user = '''
术语：{{term}}
学科：{{subject_label}}
来源：{{sources}}
上下文（OCR）：{{context}}
要求：
1) 输出字段必须包含：id, term, aliases, sense_id, subject, definitions, notation, formula, usage, applications, disambiguation, related_terms, sources, search_keys, lang, confidence。
2) definitions 至少包含 2 条（strict + alternative），必要时再补充 informal，且每条定义包含 reference 字段（来源为上面的 sources）。
3) 数学符号与公式必须使用 LaTeX。
4) related_terms 至少 3 个。
5) 仅输出 JSON 对象。
6) 内容必须更具体，避免空泛表述。
示例（格式参考，内容需针对当前术语生成）：
{{example}}
'''

prompt_example = '''
{
  "id": "ma-柯西列",
  "term": "柯西列",
  "aliases": ["Cauchy 列"],
  "sense_id": "1",
  "subject": "数学分析",
  "definitions": [
    {
      "type": "strict",
      "text": "在度量空间 $(X,d)$ 中，序列 $\\{x_n\\}$ 称为柯西列，若对任意 $\\epsilon>0$，存在 $N$ 使得当 $m,n\\ge N$ 时，有 $d(x_m,x_n)<\\epsilon$。",
      "conditions": "$(X,d)$ 为度量空间",
      "notation": "$d(x_m,x_n)$",
      "reference": "教材/讲义 第1页"
    }
  ],
  "notation": "$d(x_m,x_n)$",
  "formula": ["\\\\forall\\\\epsilon>0\\\\,\\\\exists N\\\\,\\\\forall m,n\\\\ge N:\\\\,d(x_m,x_n)<\\\\epsilon"],
  "usage": "用于刻画序列在度量空间中的内在收敛性，不依赖极限点是否存在。",
  "applications": "用于证明完备性与收敛性等价性质；在函数空间中用于一致收敛的判别。",
  "disambiguation": "不同于一般收敛，柯西列只要求后项彼此接近。",
  "related_terms": ["完备性", "收敛", "度量空间"],
  "sources": ["教材/讲义 第1页"],
  "search_keys": ["柯西列", "cauchy列", "cauchy"],
  "lang": "zh",
  "confidence": "medium"
}
'''

prompt_repair_system = '''
你是数学术语编纂助手。请修复并补全 JSON。必须严格输出 JSON 对象，不要输出多余解释。
'''

prompt_repair_user = '''
术语：{{term}}
学科：{{subject_label}}
问题：{{reason}}
请在保持结构完整的前提下补全内容，至少包含 1 条 strict 定义，并补齐公式、usage、applications、related_terms、sources。
definitions 中每条定义必须包含 reference 字段。
仅输出修复后的 JSON 对象。
当前 JSON：
{{bad_json}}
'''
